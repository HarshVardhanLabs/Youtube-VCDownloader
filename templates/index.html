<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Downloader</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        .progress {
            margin-top: 20px;
        }
        #progressSection {
            display: none;
        }
        .metadata {
            margin-bottom: 20px;
        }
        .metadata p {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">YouTube Video Downloader</h1>

        <!-- Fetch Metadata Form -->
        <form id="fetchForm" class="mb-4">
            <div class="input-group">
                <input type="text" class="form-control" name="video_url" placeholder="Enter YouTube URL" required>
                <button class="btn btn-primary" type="submit">Fetch Metadata</button>
            </div>
        </form>

        <!-- Video Metadata Display -->
        <div id="metadataSection" class="metadata" style="display: none;">
            <p><strong>Title:</strong> <span id="videoTitle"></span></p>
            <p><strong>Description:</strong> <span id="videoDescription"></span></p>
            <p><strong>Views:</strong> <span id="videoViews"></span></p>
        </div>

        <!-- Metadata Table -->
        <div class="table-responsive">
            <table id="formatTable" class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Extension</th>
                        <th>Resolution</th>
                        <th>FPS</th>
                        <th>Size</th>
                        <th>Note</th>
                        <th>Select</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Download Form -->
        <form id="downloadForm" class="mt-4">
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="videoUrlInput" name="video_url" placeholder="Enter YouTube URL" readonly required>
                <input type="text" class="form-control" id="formatIdInput" name="format_id" placeholder="Enter Format ID or Select Below" readonly required>
                <button class="btn btn-success" type="submit">Download</button>
            </div>
        </form>

        <!-- Progress and Status -->
        <div id="progressSection">
            <div class="progress">
                <div id="downloadProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;"></div>
            </div>
            <p id="statusMessage" class="mt-3"></p>
        </div>
    </div>

    <script>
        // Fetch metadata
        document.getElementById('fetchForm').onsubmit = async function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const response = await fetch('/fetch_metadata', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.status === 'success') {
                // Display video metadata
                document.getElementById('videoTitle').textContent = data.title;
                document.getElementById('videoDescription').textContent = data.description;
                document.getElementById('videoViews').textContent = data.views;
                document.getElementById('metadataSection').style.display = 'block';  // Show metadata section

                // Populate formats table
                const tableBody = document.querySelector('#formatTable tbody');
                tableBody.innerHTML = data.formats.map(format => `
                    <tr>
                        <td>${format.id}</td>
                        <td>${format.ext}</td>
                        <td>${format.resolution}</td>
                        <td>${format.fps}</td>
                        <td>${format.size === 'Unknown' ? 'N/A' : `${(format.size / (1024 * 1024)).toFixed(2)} MB`}</td>
                        <td>${format.note}</td>
                        <td><button class="btn btn-sm btn-primary selectFormat" data-id="${format.id}">Select</button></td>
                    </tr>
                `).join('');

                document.getElementById('videoUrlInput').value = formData.get('video_url'); // Populate URL for download form
            } else {
                alert(`Error: ${data.message}`);
            }
        };

        // Select format from the table
        document.querySelector('#formatTable').addEventListener('click', function (e) {
            if (e.target.classList.contains('selectFormat')) {
                const formatId = e.target.dataset.id;
                document.getElementById('formatIdInput').value = formatId;
            }
        });

        // Download video and audio
        document.getElementById('downloadForm').onsubmit = async function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('statusMessage').textContent = 'Downloading and merging...';
            document.getElementById('downloadProgress').style.width = '0%';

            const response = await fetch('/download_video', { method: 'POST', body: formData });
            const data = await response.json();

            if (data.status === 'success') {
                document.getElementById('statusMessage').textContent = 'Download and merge completed successfully!';
                document.getElementById('downloadProgress').style.width = '100%';
                const link = document.createElement('a');
                link.href = data.output_file;
                link.download = data.output_file.split('/').pop();
                link.textContent = 'Click here to download the merged file';
                document.getElementById('statusMessage').appendChild(document.createElement('br'));
                document.getElementById('statusMessage').appendChild(link);
            } else {
                document.getElementById('statusMessage').textContent = `Error: ${data.message}`;
                document.getElementById('downloadProgress').style.width = '0%';
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
